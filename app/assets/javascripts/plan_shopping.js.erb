function hidePlanTabs() {
  $(".all-filters-row").hide();
  $("ul[role='tablist'] li[role='presentation']").each(function(idx, ele) {
    $(ele).removeClass("active");
  });
}

function combineAllPlanSelectors(planSelectors) {
  var selectors = [];
  var baseSelector = $(".plan-row");
  var combinedSelectors = baseSelector;
  combinedSelectors.hide();
  for (var i = 0; i < planSelectors.length; i++) {
    combinedSelectors = combinedSelectors.filter(planSelectors[i]);
  }
  combinedSelectors = filterPlanByRange("premium", combinedSelectors);
  combinedSelectors = filterPlanByRange("deductible", combinedSelectors);
  combinedSelectors = filterPlanBySelect("carrier", combinedSelectors);
  combinedSelectors = filterPlanBySelect("hsa-eligibility", combinedSelectors);
  combinedSelectors.show();
}

function filterPlanBySelect(type, combinedSelectors) {
  var carrier = $("select.plan-"+type+"-selection-filter").val();
  if (carrier == "" || carrier == undefined) {
    return combinedSelectors;
  } else {
    var selectors = combinedSelectors.filter(function(){
      return (carrier == $(this).data("plan-"+type));
    });
    return selectors;
  }
}

function filterPlanByRange(type, combinedSelectors) {
  var from = parseFloat($("input.plan-metal-"+type+"-from-selection-filter").val().replace(/[^\d\.]/g,''));
  var to= parseFloat($("input.plan-metal-"+type+"-to-selection-filter").val().replace(/[^\d\.]/g,''));
  if (isNaN(from) || isNaN(to)){
    return combinedSelectors;
  } else {
    var selectors = combinedSelectors.filter(function(){
      var premium = parseFloat($(this).data("plan-metal-"+type).toString().replace(/[^\d\.]/g,''));
      return (premium >= from && premium <= to);
    });
    return selectors;
  }
}

function applyPlanFilterCBs(cbKlass, cbFilterKlass, planValueTag) {
  var selectedPlanTypes = [];
  var spCheckboxes = $('input.' + cbKlass + ':checked');
  if (spCheckboxes.size() > 0) {
    spCheckboxes.each(function(idx, ele) {
      var ptName = $(ele).attr(cbFilterKlass);
      var qstring = "[" + planValueTag  + "='" + ptName + "']";
      selectedPlanTypes.push(qstring);
    });
    return $(selectedPlanTypes.join(", "));
  } else {
    return $("[" + planValueTag + "]");
  }
}

function applyPlanFilters() {
  var all_selectors = [ 
    applyPlanFilterCBs("plan-type-selection-filter", "data-plan-category-filter", "data-plan-category"),
    applyPlanFilterCBs("plan-metal-level-selection-filter", "data-plan-metal-level-filter", "data-plan-metal-level"),
    applyPlanFilterCBs("plan-metal-network-selection-filter", "data-plan-metal-network-filter", "data-plan-metal-network")
  ];
  combineAllPlanSelectors(all_selectors);
  $("strong#plans-count").text($(".plan-row:visible").length);
}

var plansToCompareArray = new Array();
var hbx;

function maybeAddComparisonPlan(cb) {
	var new_plan = $(cb).attr("data-hios-id");
  hbx =  $(cb).attr("data-hbx-id");
	var is_checked = $(cb).prop("checked");
	if (is_checked) {
		if (plansToCompareArray.length > 2) {
      $("#plans-compare-alert").modal("show");
			var removed_id = plansToCompareArray.shift();
			var lookup_string = "input[data-hios-id='" +
				removed_id + "'].select-plan-for-comparison";
			$(lookup_string).each(function(idx, ele) {
				$(ele).attr("checked", false);
			});
		}
		plansToCompareArray.push(new_plan);
	} else {
		var tmpArray = [];
		for (var i = 0; i < plansToCompareArray.length; i++) {
			if (plansToCompareArray[i] != new_plan) {
				tmpArray.push(plansToCompareArray[i]);
			}
		}
		plansToCompareArray = tmpArray;
	}
	if (plansToCompareArray.length > 1) {
		$(".compare-selected-plans-link").show();
	} else {
		$(".compare-selected-plans-link").hide();
	}
}

function doPlanComparison(action_uri) {
	$.ajax({
		type: "GET",
	url: action_uri,
	dataType: 'script',
	data: {
		"standard_component_ids": plansToCompareArray,"hbx_enrollment_id":hbx
	}
	});
}

function applyPlanSort(sort_by){
  var plandivs = $('#all-plans #plans .plan-row');
  plandivs.sort(function(a, b){
    if (sort_by == "plan-metal-premium" || sort_by == "plan-metal-deductible"){
      var keyA = parseFloat($(a).data(sort_by).toString().replace(/[^\d\.]/g,''));
      var keyB = parseFloat($(b).data(sort_by).toString().replace(/[^\d\.]/g,''));
    }else{
      var keyA = $(a).data(sort_by);
      var keyB = $(b).data(sort_by);
    }
    return (keyA > keyB) ? 1 : -1;
  });
  $("#all-plans #plans").empty().append(plandivs);
};

$(function() {
	$("#select-plan-container a[role='tab'][data-toggle='tab']").click(function() {
		hidePlanTabs();
		$(this).parent().addClass("active");
		var attr = $(this).attr("data-plan-category-filter");
		if (typeof attr !== typeof undefined && attr !== false) {
			if (attr == "all") {
				$(".plan-row").show();
			} else {
				$(".plan-row").hide();
				var qstring = ".plan-row[data-plan-category='" + attr + "']";
				$(qstring).show();
			}
		}
	});

	$(".select-plan-for-comparison").change(function() {
		maybeAddComparisonPlan(this);
	});

	$(".compare-selected-plans-link").click(function() {

		var base_url = $(this).attr("data-uri");

		doPlanComparison(base_url);
	});

	$(".all-filters-row .apply-btn").on('click', function() {
		// $(".all-filters-row").hide();
		applyPlanFilters();
	});

  $(".all-filters-row .reset-btn").on('click', function() {
    $(".filter-sidebar input[type='checkbox']").attr("checked", false);
    $(".filter-sidebar input[type='text'].plan-metal-premium-from-selection-filter").val("0");
    $(".filter-sidebar input[type='text'].plan-metal-premium-to-selection-filter").val($('#max_total_employee_cost').val());
    $(".filter-sidebar input[type='text'].plan-metal-deductible-from-selection-filter").val("0");
    $(".filter-sidebar input[type='text'].plan-metal-deductible-to-selection-filter").val($('#max_deductible').val());
    $(".filter-sidebar select.plan-carrier-selection-filter").prop('selectedIndex', 0).selectric('refresh');
    $(".filter-sidebar select.plan-hsa-eligibility-selection-filter").prop('selectedIndex', 0).selectric('refresh');
		applyPlanFilters();
  });

  $(document).on('click', '#sort_by a', function(){
    applyPlanSort($(this).data('sort-by'));
  });
});

//for plan_year
$(document).on("change", "select[name='reference_plan']", function() {
  var reference_plan_id = $(this).val();
  if (reference_plan_id != "" && reference_plan_id != undefined){
    $(this).parents('.reference-plan-select').find("input[type='hidden']").val(reference_plan_id);
    $(this).parents('fieldset').find('.reference_plan_info h4').html("loading...")
    $.ajax({
      type: "GET",
      url: $('a#search_reference_plan_link').data('href'),
      dataType: 'script',
      data: {
        "reference_plan_id": reference_plan_id,
        "location_id": $(this).parents('fieldset').attr('id')
      }
    }).done(function() {
      calcEmployerContributions();
    });
  };
});

$(function() {
  $('.contribution_handler').each(function() {
    $(this).change(function(){
      calcEmployerContributions();
    });
  });
});

function calcEmployerContributions() {

  var relation_benefits = { 
    "0": { 
      "relationship": "employee", 
      "premium_pct": $('#plan_year_benefit_groups_attributes_0_relationship_benefits_attributes_0_premium_pct').val(), 
      "offered": $('#plan_year_benefit_groups_attributes_0_relationship_benefits_attributes_0_offered').is(":checked")
    }, 
    "1": { 
      "relationship": "spouse", 
      "premium_pct": $('#plan_year_benefit_groups_attributes_0_relationship_benefits_attributes_1_premium_pct').val(), 
      "offered": $('#plan_year_benefit_groups_attributes_0_relationship_benefits_attributes_1_offered').is(":checked")
    }, 
    "2": { 
      "relationship": "domestic_partner", 
      "premium_pct": $('#plan_year_benefit_groups_attributes_0_relationship_benefits_attributes_2_premium_pct').val(), 
      "offered": $('#plan_year_benefit_groups_attributes_0_relationship_benefits_attributes_2_offered').is(":checked")
    }, 
    "3": { 
      "relationship": "child_under_26", 
      "premium_pct": $('#plan_year_benefit_groups_attributes_0_relationship_benefits_attributes_3_premium_pct').val(), 
      "offered": $('#plan_year_benefit_groups_attributes_0_relationship_benefits_attributes_3_offered').is(":checked")
    }, 
    "4": {
      "relationship": "child_26_and_over", 
      "premium_pct": $('#plan_year_benefit_groups_attributes_0_relationship_benefits_attributes_4_premium_pct').val(), 
      "offered": $('#plan_year_benefit_groups_attributes_0_relationship_benefits_attributes_4_offered').is(":checked")
    }
  }

  var reference_plan_id = $("#plan_year_benefit_groups_attributes_0_reference_plan_id").val();
  var location_id = $("#plan_year_benefit_groups_attributes_0_reference_plan_id").parents('fieldset').attr('id');

  if (reference_plan_id != "" && reference_plan_id != undefined){
  $("fieldset#"+ location_id +" .employer_cost_info .loader").toggle();
  $.ajax({
      type: "GET",
      url: $('a#calc_employer_contributions_link').data('href'),
      dataType: 'script',
      data: {
        "start_on": $("#plan_year_start_on").val(),
        "reference_plan_id": reference_plan_id,
        "location_id": location_id,
        "relation_benefits": relation_benefits
      }
    }).done(function() {
      $("fieldset#"+ location_id +" .employer_cost_info .loader").hide();
    });;
}
}

$(document).on("click", ".reference_plan_info h4 span", function() {
  $(this).parents(".reference_plan_info").find('.content').toggle();
});
